{% extends 'layout.html' %}

{% block content %}
<!-- <h1>{{title}}</h1>
    <p>Welcome to {{title}}</p> -->
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-8 py-5 text-center">
        <img class="d-block mx-auto mb-4" src="https://static.wixstatic.com/media/b65abb_0c7330f3d53d47f199e272b1ff20dbb8~mv2.png/v1/crop/x_0,y_0,w_983,h_296/fill/w_268,h_80,al_c,q_85,usm_0.66_1.00_0.01/20210310_144716.webp" alt="" width="72">
        <!-- <h2>Checkout form</h2>
        <p class="lead">Below is an example form built entirely with Bootstrap’s form controls. Each required form group has a validation state that can be triggered by attempting to submit the form without completing it.</p> -->
        <h2>몰트 적립 신청서</h2>
        <p class="lead">오늘 하루도 고생하셨습니다.</p>
    </div>
    <div class="col-md-8 col-lg-8">
      <!-- <h4 class="mb-3">Billing address</h4> -->
      <h4 class="mb-3">몰트 적립을 지금 바로 신청하세요.</h4>
      <form class="needs-validation" novalidate="" id="kakaoForm">
        <div class="row g-3">
          <div class="col-sm-6">

            <div class="col-12">
              <label for="email" class="form-label">Email <span class="text-muted"></span></label>
              <select class="form-select" aria-label="select email" id="userEmail" name="userEmail" required>
                <option value="" selected>Select User Email</option>
              </select>
            </div>

            <label for="name" class="form-label">신청자</label>
            <input type="text" class="form-control" name="name" id="name" placeholder="이름" value="" required="">
            <!-- <label for="firstName" class="form-label">First name</label>
            <input type="text" class="form-control" name="firstName" id="firstName" placeholder="" value="" required=""> -->
            <div class="invalid-feedback">
              Valid first name is required.
            </div>
          </div>

          <div class="col-sm-6">
            <label for="date" class="form-label">근무일</label>
            <input type="date" class="form-control" name="date" id="date" placeholder="2021.01.01." value="" required="">
            <!-- <label for="lastName" class="form-label">Last name</label>
            <input type="text" class="form-control" name="lastName" id="lastName" placeholder="" value="" required=""> -->
            <div class="invalid-feedback">
              Valid last name is required.
            </div>
          </div>

          <!-- <div class="col-12">
            <label for="username" class="form-label">Username</label>
            <div class="input-group has-validation">
              <span class="input-group-text">@</span>
              <input type="text" class="form-control" id="username" placeholder="Username" required="">
            <div class="invalid-feedback">
                Your username is required.
              </div>
            </div>
          </div> -->

          <div class="col-12">
            <!-- <label for="email" class="form-label">Email <span class="text-muted">(Optional)</span></label>
            <input type="email" class="form-control" id="email" placeholder="you@example.com"> -->
            <label for="workinghours" class="form-label">근무시간 <span class="text-muted">(30분 단위로 입력)</span></label>
            <input type="text" class="form-control" name="workinghours" id="workinghours" placeholder="18:00~21:30">
            <div class="invalid-feedback">
              Please enter a valid email address for shipping updates.
            </div>
          </div>

          <div class="col-12">
            <label for="details" class="form-label">근무내용</label>
            <input type="text" class="form-control" name="details" id="details" placeholder="주요 근무 내용 요약" required="">
            <!-- <label for="address" class="form-label">Address</label>
            <input type="text" class="form-control" id="address" placeholder="1234 Main St" required=""> -->
            <div class="invalid-feedback">
              Please enter your shipping address.
            </div>
          </div>

          <div class="col-12">
            <!-- <label for="address2" class="form-label">Address 2 <span class="text-muted">(Optional)</span></label>
            <input type="text" class="form-control" id="address2" placeholder="Apartment or suite"> -->
            <label for="malts" class="form-label">적립/차감 몰트</label>
            <input type="text" class="form-control" name="malts" id="malts" placeholder="22:00 이후 2배 적립">
          </div>

          <!-- <div class="col-md-5">
            <label for="country" class="form-label">Country</label>
            <select class="form-select" id="country" required="">
              <option value="">Choose...</option>
              <option>United States</option>
            </select>
            <div class="invalid-feedback">
              Please select a valid country.
            </div>
          </div>

          <div class="col-md-4">
            <label for="state" class="form-label">State</label>
            <select class="form-select" id="state" required="">
              <option value="">Choose...</option>
              <option>California</option>
            </select>
            <div class="invalid-feedback">
              Please provide a valid state.
            </div>
          </div>

          <div class="col-md-3">
            <label for="zip" class="form-label">Zip</label>
            <input type="text" class="form-control" id="zip" placeholder="" required="">
            <div class="invalid-feedback">
              Zip code required.
            </div>
          </div> -->
        </div>

        <hr class="my-4">

        <!-- <div class="form-check">
          <input type="checkbox" class="form-check-input" id="same-address">
          <label class="form-check-label" for="same-address">Shipping address is the same as my billing address</label>
        </div>

        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="save-info">
          <label class="form-check-label" for="save-info">Save this information for next time</label>
        </div>

        <hr class="my-4"> -->

        <button class="w-100 btn btn-primary btn-lg" type="submit">적립 신청</button>
      </form>
    </div>
  </div>
  <script>

      let userNameInput = document.querySelector('input[name=name]');
      let userEamilInput = document.getElementById("userEmail");
      function getUserEmail() {
        axios.get('/users/list').then(function(result){
          console.log(result.data);
          result.data.forEach(function(user) {
            let opt = document.createElement("option");
            opt.value = [user.id, user.name, user.email].join("|");
            opt.text = user.email;
            userEamilInput.add(opt, null);
          });
        });
      }
      getUserEmail();

      userEamilInput.addEventListener("change", function(event) {
        userNameInput.value = event.target.value.split("|")[1];
      });

      let form = document.getElementById("kakaoForm");

      let dateControl = document.querySelector('input[type="date"]');
      dateControl.value = new Date().toISOString('ko').slice(0, 10);

      function handleSubmit(event) {
        event.preventDefault();
        const data = new FormData(event.target);
        const name = data.get("name");
        const date = data.get("date");
        const userEmailValue = data.get("userEmail");
        const workingHours = data.get("workinghours");
        const details = data.get("details");
        const malts = data.get("malts");
        // console.log(firstNameValue);

        if (!userEmailValue) {
            Swal.fire("이메일을 선택해주세요");
            return;
          }

          if (!name) {
            Swal.fire("이름을 입력해주세요");
            return;
          }

          if (!malts) {
            Swal.fire("적립 몰트를 입력해주세요");
            return;
          }

        let postData = {};
        postData.name = name;
        postData.date = date;
        postData.workingHours = workingHours;
        postData.details = details;
        postData.malts = malts;
        postData.userEmail = userEmailValue.split("|")[2];
        postData.userId = userEmailValue.split("|")[0];

        axios.post('/info', postData).then(function(result){
            console.log(result);
            form.reset();
            Swal.fire(result.data.success ? "몰트 적립 신청 완료" : "메세지를 보내지 못했습니다.");
        });
      }

      form.addEventListener('submit', handleSubmit);
  </script>
{% endblock %}